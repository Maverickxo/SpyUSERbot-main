from config import CONFIG_FILE
import os
import json
# Функция загрузки конфигурации
def load_config():
    """
    Загружает и проверяет файл конфигурации маршрутов.

    Функция читает файл конфигурации JSON, валидирует его структуру, извлекает маршруты
    и возвращает их в виде словаря. Если файл отсутствует или имеет некорректную структуру,
    возвращается пустой словарь.

    Возвращаемое значение:
    - dict: Словарь, где ключи — это `from_id` (ID чатов-источников),
      а значения — маршруты, включая правила и данные о целевых чатах.

    Файл конфигурации должен иметь следующую структуру:
    {
        "routes": [
            {
                "from_id": <ID чата-источника>,
                "from_name": "<Название чата-источника>",
                "to_id": <ID чата-получателя>,
                "to_name": "<Название чата-получателя>",
                "rules": {
                    "keywords": [<Список ключевых слов>],
                    "min_length": <Минимальная длина сообщения>
                }
            },
            ...
        ]
    }

    Обработка ошибок:
    - Если файл конфигурации отсутствует, выводится предупреждение, и возвращается пустой словарь.
    - Если структура JSON некорректна или отсутствует ключ `routes`, выводится сообщение об ошибке,
      и возвращается пустой словарь.
    - Если JSON повреждён (ошибка чтения), ошибка выводится в консоль, и возвращается пустой словарь.

    Пример использования:
    >>> routes = load_config()
    >>> print(routes)
    {
        -1001234567890: {
            "from_id": -1001234567890,
            "from_name": "Источник",
            "to_id": -1009876543210,
            "to_name": "Получатель",
            "rules": {
                "keywords": ["важно", "срочно"],
                "min_length": 10
            }
        }
    }

    Исключения:
    - Отсутствие файла конфигурации — вывод в консоль:
      "Файл конфигурации config.json не найден. Проверьте наличие файла."
    - Некорректная структура файла:
      "Ошибка: Некорректная структура файла конфигурации."
    - Ошибка чтения JSON:
      "Ошибка чтения JSON: <текст ошибки>"
    """

    if not os.path.exists(CONFIG_FILE):
        print(f"Файл конфигурации {CONFIG_FILE} не найден. Проверьте наличие файла.")
        return {}  # Возвращаем пустой словарь, если файла нет

    try:
        with open(CONFIG_FILE, "r", encoding="utf-8") as file:
            config = json.load(file)

        # Проверка структуры конфигурации
        if "routes" not in config or not isinstance(config["routes"], list):
            print("Ошибка: Некорректная структура файла конфигурации.")
            return {}

        routes = {route["from_id"]: route for route in config["routes"]}
        return routes

    except json.JSONDecodeError as e:
        print(f"Ошибка чтения JSON: {e}")
        return {}  # Возвращаем пустой словарь в случае ошибки
